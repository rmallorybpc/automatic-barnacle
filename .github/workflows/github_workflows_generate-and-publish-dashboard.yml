name: Generate and publish initial dashboard
on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests urllib3

      - name: Prepare data directories
        run: |
          mkdir -p data/{graphql,embeddings,reports,issues,dashboard}
          mkdir -p docs/reports

      - name: Run monitoring pipeline modules
        run: |
          set -euxo pipefail
          python -m src.feature_monitor.ingestion || true
          python -m src.feature_monitor.modules_index || true
          python -m src.feature_monitor.embeddings || true
          python -m src.feature_monitor.coverage || true
          python -m src.feature_monitor.report || true
          # Dashboard should produce data/dashboard/dashboard_latest.json
          python -m src.feature_monitor.dashboard

      - name: Generate dashboard delta (exec summary)
        run: |
          set -euxo pipefail
          python -m src.feature_monitor.dashboard_delta \
            --old docs/reports/dashboard.json \
            --new data/dashboard/dashboard_latest.json \
            --out-json docs/reports/dashboard_delta.json \
            --out-md docs/reports/dashboard_delta.md

      - name: Publish dashboard.json to docs/reports
        run: |
          set -euxo pipefail
          if [ ! -f data/dashboard/dashboard_latest.json ]; then
            echo "ERROR: data/dashboard/dashboard_latest.json was not produced. Check module logs above." >&2
            exit 1
          fi
          cp data/dashboard/dashboard_latest.json docs/reports/dashboard.json
          echo "Dashboard copied to docs/reports/dashboard.json"
          ls -la docs/reports

      - name: Commit and push dashboard.json to main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Ensure weâ€™re tracking main
          git fetch origin main
          git checkout -B main origin/main
          git add docs/reports/dashboard.json docs/reports/dashboard_delta.json docs/reports/dashboard_delta.md
          git commit -m "Publish first pipeline-generated dashboard.json via one-off workflow" || echo "No changes to commit"
          git push origin HEAD:main
