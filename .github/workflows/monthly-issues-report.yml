name: Monthly Issues Report

on:
  schedule:
    # Run on the 1st of each month at 10 AM UTC
    - cron: '0 10 1 * *'
  workflow_dispatch:

jobs:
  generate-monthly-report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests urllib3
      
      - name: Create data directories
        run: |
          mkdir -p data/{graphql,embeddings,reports/monthly,issues,dashboard}
      
      - name: Run full pipeline (to get latest data)
        run: |
          echo "=== Running ingestion ==="
          python -m src.feature_monitor.ingestion
          
          echo "=== Running indexing ==="
          python -m src.feature_monitor.modules_index
          
          echo "=== Generating embeddings ==="
          python -m src.feature_monitor.embeddings
          
          echo "=== Generating report ==="
          python -m src.feature_monitor.report
        continue-on-error: false
      
      - name: Generate monthly report
        run: |
          echo "=== Generating monthly report ==="
          python -m src.feature_monitor.monthly_report
      
      - name: Send monthly notifications
        run: |
          echo "=== Sending monthly notifications ==="
          python -m src.feature_monitor.notifications
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        continue-on-error: true
      
      - name: Upload monthly report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monthly-report
          path: |
            data/reports/monthly/*.json
            data/reports/monthly/*.md
          retention-days: 90
