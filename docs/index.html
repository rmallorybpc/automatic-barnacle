<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Automatic Barnacle Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 2rem; }
    header { margin-bottom: 1rem; }
    .status { margin: 1rem 0; padding: 0.75rem; background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; }
    pre { background: #f6f8fa; padding: 1rem; border-radius: 6px; overflow: auto; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #d0d7de; padding: 0.5rem; text-align: left; }
    th { background: #f0f3f6; }
    .error { color: #b42318; }
    .ok { color: #1a7f37; }
  </style>
</head>
<body>
  <header>
    <h1>Automatic Barnacle Dashboard</h1>
    <p>Static site served from docs/. This page loads reports/dashboard.json when available.</p>
  </header>

  <div id="status" class="status">Loading dashboard dataâ€¦</div>

  <section id="summary" hidden>
    <h2>Summary</h2>
    <div id="summaryContent"></div>
  </section>

  <section id="raw" hidden>
    <h2>Raw dashboard.json</h2>
    <pre id="rawJson"></pre>
  </section>

  <script>
    // Helper function to escape HTML entities
    function escapeHtml(text) {
      const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    async function loadDashboard() {
      const statusEl = document.getElementById('status');
      const summaryEl = document.getElementById('summary');
      const summaryContentEl = document.getElementById('summaryContent');
      const rawEl = document.getElementById('raw');
      const rawJsonEl = document.getElementById('rawJson');

      const url = 'reports/dashboard.json'; // relative to docs/
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          statusEl.innerHTML = `<strong class="error">dashboard.json not found</strong>. Once your pipeline runs, it will copy reports/dashboard.json into docs/reports/dashboard.json.`;
          return;
        }
        const data = await res.json();
        statusEl.innerHTML = `<strong class="ok">dashboard.json loaded</strong>`;
        summaryEl.hidden = false;
        rawEl.hidden = false;

        // Render a simple summary if common keys exist
        const keys = Object.keys(data || {});
        let html = '';
        if (Array.isArray(data.features)) {
          html += `<p><strong>Features:</strong> ${data.features.length}</p>`;
        }
        if (Array.isArray(data.gaps)) {
          html += `<p><strong>Gaps:</strong> ${data.gaps.length}</p>`;
        }
        if (!html) {
          const safeKeys = keys.map(escapeHtml).join(', ') || '(none)';
          html = `<p>dashboard.json loaded. Keys: ${safeKeys}</p>`;
        }
        summaryContentEl.innerHTML = html;

        rawJsonEl.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        // Use textContent to prevent XSS from error messages
        statusEl.textContent = '';
        const errorLabel = document.createElement('strong');
        errorLabel.className = 'error';
        errorLabel.textContent = 'Error loading dashboard.json: ';
        statusEl.appendChild(errorLabel);
        statusEl.appendChild(document.createTextNode(String(e)));
      }
    }

    loadDashboard();
  </script>
</body>
</html>
